<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AFT Appointment Portal</title>
  <!-- Remove Google Fonts and use system fonts instead -->
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
    }
    header {
      background: linear-gradient(to right, #2563eb, #1e40af);
      color: white;
      padding: 1.5rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      letter-spacing: 0.5px;
    }
    .container {
      max-width: 900px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    h2 {
      margin-bottom: 1rem;
      color: #111827;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 0.5rem;
    }
    label {
      display: block;
      margin-top: 1.2rem;
      font-weight: 500;
      color: #374151;
    }
    input, select {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.4rem;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      font-size: 1rem;
      background-color: #f9fafb;
    }
    input[type="date"] {
      background-color: #fff;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.75rem 1.5rem;
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s ease;
    }
    button:hover {
      background-color: #1e40af;
    }
    table {
      width: 100%;
      margin-top: 2rem;
      border-collapse: collapse;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 0.9rem;
      text-align: left;
    }
    th {
      background-color: #f3f4f6;
    }
    td {
      background-color: #ffffff;
    }
    .actions button {
      margin-right: 6px;
      padding: 6px 12px;
      font-size: 0.85rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .done-btn {
      background-color: #10b981;
      color: white;
    }
    .delete-btn {
      background-color: #ef4444;
      color: white;
    }
    .edit-btn {
      background-color: #3b82f6;
      color: white;
    }
    .done-row {
      background-color: #e5f9f0;
      text-decoration: line-through;
      opacity: 0.6;
    }
  </style>
</head>
<body>

  <header>
    AFT Patient Appointment Portal
  </header>

  <div class="container">
    <h2>Book an Appointment</h2>
    <form id="appointmentForm">
      <label for="hospitalId">Hospital ID</label>
      <input type="text" id="hospitalId" name="hospitalId" />

      <label for="patientName">Patient Name</label>
      <input type="text" id="patientName" name="patientName" />

      <label for="age">Age</label>
      <input type="number" id="age" name="age" />

      <label for="gender">Gender</label>
      <select id="gender" name="gender">
        <option value="">Select</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>

      <label for="phone">Phone Number</label>
      <input type="tel" id="phone" name="phone" placeholder="10-digit number" />

      <label for="testType">Test Type</label>
      <select id="testType" name="testType">
        <option value="">Select</option>
        <option>AFT</option>
        <option>Tilt Table</option>
      </select>

      <label for="date">Appointment Date</label>
      <select id="date" name="date">
        <option value="">Select</option>
        <option value="Not given yet">Not given yet</option>
        <option value="custom">Choose date...</option>
      </select>
      <input type="date" id="customDate" style="display:none; margin-top: 0.5rem;" />

      <button type="submit">Submit Appointment</button>
    </form>

    <div class="upcoming-appointments">
      <h2>Upcoming Appointments</h2>
      <table id="upcomingAppointmentsTable">
        <thead>
          <tr>
            <th>Hospital ID</th>
            <th>Patient Name</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Phone</th>
            <th>Test Type</th>
            <th>Date</th>
            <th>Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Upcoming appointments will be added here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase App (the core Firebase SDK) -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      deleteDoc, 
      doc, 
      updateDoc, 
      onSnapshot,
      getDoc,
      initializeFirestore,
      persistentLocalCache,
      persistentMultipleTabManager
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDwBApRaaYe-f090YKox2-dMVyJ-a4NUCw",
      authDomain: "aft-appointments.firebaseapp.com",
      projectId: "aft-appointments",
      storageBucket: "aft-appointments.firebasestorage.app",
      messagingSenderId: "742717346474",
      appId: "1:742717346474:web:ec5a98b93f32604d8df6d3"
    };

    // Initialize Firebase
    let app;
    let db;
    let appointmentsCollection;
    let retryCount = 0;
    const MAX_RETRIES = 3;
    let isFirebaseInitialized = false;

    // Make functions available globally
    window.markDone = async function(appointmentId, isDone) {
      if (!isFirebaseInitialized) {
        alert("Please wait while the application initializes...");
        return;
      }
      try {
        const appointmentRef = doc(db, "appointments", appointmentId);
        await updateDoc(appointmentRef, {
          status: isDone ? 'done' : 'pending'
        });
      } catch (error) {
        console.error("Error updating appointment: ", error);
        alert("Error updating appointment. Please try again.");
      }
    };

    window.deleteAppointment = async function(appointmentId) {
      if (!isFirebaseInitialized) {
        alert("Please wait while the application initializes...");
        return;
      }
      if (confirm("Are you sure you want to delete this appointment?")) {
        try {
          await deleteDoc(doc(db, "appointments", appointmentId));
        } catch (error) {
          console.error("Error deleting appointment: ", error);
          alert("Error deleting appointment. Please try again.");
        }
      }
    };

    window.editAppointment = async function(appointmentId) {
      if (!isFirebaseInitialized) {
        alert("Please wait while the application initializes...");
        return;
      }
      try {
        const appointmentRef = doc(db, "appointments", appointmentId);
        const appointmentDoc = await getDoc(appointmentRef);
        const appointment = appointmentDoc.data();

        document.getElementById("hospitalId").value = appointment.hospitalId || '';
        document.getElementById("patientName").value = appointment.name || '';
        document.getElementById("age").value = appointment.age || '';
        document.getElementById("gender").value = appointment.gender || '';
        document.getElementById("phone").value = appointment.phone || '';
        document.getElementById("testType").value = appointment.testType || '';

        if (appointment.date === "Not given yet") {
          dateSelect.value = "Not given yet";
          customDate.style.display = "none";
          customDate.value = "";
        } else {
          dateSelect.value = "custom";
          customDate.style.display = "block";
          customDate.value = appointment.date;
        }

        // Delete the old appointment
        await window.deleteAppointment(appointmentId);
      } catch (error) {
        console.error("Error editing appointment: ", error);
        alert("Error editing appointment. Please try again.");
      }
    };

    async function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        
        // Initialize Firestore with proper settings
        db = initializeFirestore(app, {
          localCache: persistentLocalCache({
            tabManager: persistentMultipleTabManager()
          }),
          ignoreUndefinedProperties: true
        });

        // Create a separate appointments collection
        appointmentsCollection = collection(db, "appointments");

        // Test the connection
        try {
          await getDocs(appointmentsCollection);
          console.log('Firebase connection test successful');
        } catch (error) {
          console.error('Firebase connection test failed:', error);
          throw error;
        }

        // Make Firebase functions available globally
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.onSnapshot = onSnapshot;
        window.getDoc = getDoc;
        window.appointmentsCollection = appointmentsCollection;

        isFirebaseInitialized = true;
        console.log('Firebase initialized successfully with persistent cache');
        return true;
      } catch (error) {
        console.error("Error initializing Firebase:", error);
        if (retryCount < MAX_RETRIES) {
          retryCount++;
          console.log(`Retrying Firebase initialization (${retryCount}/${MAX_RETRIES})...`);
          await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
          return initializeFirebase();
        }
        alert("Error initializing the application. Please refresh the page.");
        return false;
      }
    }

    // Initialize Firebase immediately
    initializeFirebase();
  </script>

  <script type="module">
    // Setup page after Firebase is initialized
    function setupPage() {
      const form = document.getElementById("appointmentForm");
      const tableBody = document.querySelector("#appointmentsTable tbody");
      const dateSelect = document.getElementById("date");
      const customDate = document.getElementById("customDate");

      // Create appointment row
      function createAppointmentRow(id, appointment) {
        const row = document.createElement("tr");
        if (appointment.status === 'done') {
          row.classList.add("done-row");
        }
        row.innerHTML = `
          <td>${appointment.hospitalId || ''}</td>
          <td>${appointment.name || ''}</td>
          <td>${appointment.age || ''}</td>
          <td>${appointment.gender || ''}</td>
          <td>${appointment.phone || ''}</td>
          <td>${appointment.testType || ''}</td>
          <td>${appointment.date || ''}</td>
          <td>${appointment.time || '09:00 AM'}</td>
          <td class="actions">
            <button class="done-btn" onclick="markDone('${id}', ${!appointment.status === 'done'})">
              ${appointment.status === 'done' ? 'Undo' : 'Done'}
            </button>
            <button class="delete-btn" onclick="deleteAppointment('${id}')">Delete</button>
            <button class="edit-btn" onclick="editAppointment('${id}')">Edit</button>
          </td>
        `;
        return row;
      }

      // Load appointments from Firebase
      async function loadAppointments() {
        if (!window.isFirebaseInitialized) {
          console.error("Firebase not initialized properly");
          return;
        }

        try {
          // First try a one-time read to test the connection
          const testSnapshot = await getDocs(window.appointmentsCollection);
          console.log('Initial read successful, setting up real-time listener');

          const unsubscribe = onSnapshot(window.appointmentsCollection, 
            (snapshot) => {
              tableBody.innerHTML = ''; // Clear existing rows
              const upcomingTableBody = document.querySelector("#upcomingAppointmentsTable tbody");
              if (upcomingTableBody) {
                upcomingTableBody.innerHTML = ''; // Clear upcoming appointments
              }
              console.log('Total appointments in snapshot:', snapshot.size); // Debug log
              
              snapshot.forEach((doc) => {
                const appointment = doc.data();
                console.log('Processing appointment:', appointment); // Debug log
                const row = createAppointmentRow(doc.id, appointment);
                
                // Add to main table
                tableBody.appendChild(row);
                
                // Add to upcoming appointments if not done
                if (upcomingTableBody && appointment.status !== 'done') {
                  console.log('Raw appointment.date:', appointment.date); // Debug log
                  let appointmentDate;
                  if (appointment.date && typeof appointment.date.toDate === 'function') {
                    appointmentDate = appointment.date.toDate();
                  } else {
                    appointmentDate = new Date(appointment.date);
                  }
                  console.log('Parsed appointmentDate:', appointmentDate); // Debug log
                  // Fallback: show all non-done appointments for now
                  const upcomingRow = createAppointmentRow(doc.id, appointment);
                  upcomingTableBody.appendChild(upcomingRow);
                }
              });
            },
            (error) => {
              console.error("Error in onSnapshot:", error);
              if (error.code === 'permission-denied') {
                alert("You don't have permission to access the appointments. Please contact your administrator.");
              } else if (error.code === 'unavailable') {
                alert("The service is currently unavailable. Please try again later.");
              } else {
                alert("Error loading appointments. Please refresh the page.");
              }
            }
          );

          // Store unsubscribe function for cleanup
          window.unsubscribeAppointments = unsubscribe;
        } catch (error) {
          console.error("Error loading appointments:", error);
          if (error.code === 'permission-denied') {
            alert("You don't have permission to access the appointments. Please contact your administrator.");
          } else {
            alert("Error loading appointments. Please refresh the page.");
          }
        }
      }

      // Cleanup function
      function cleanup() {
        if (window.unsubscribeAppointments) {
          window.unsubscribeAppointments();
        }
      }

      // Add cleanup on page unload
      window.addEventListener('beforeunload', cleanup);

      // Load appointments
      loadAppointments();

      // Form submission
      form.addEventListener("submit", async function (e) {
        console.log("Form submission started"); // Debug log
        e.preventDefault();
        
        if (!window.isFirebaseInitialized) {
          console.error("Firebase not initialized"); // Debug log
          alert("Please wait while the application initializes...");
          return;
        }
        console.log("Firebase is initialized, proceeding with form submission"); // Debug log

        // Log all form field values
        console.log("Form field values:", {
          hospitalId: document.getElementById("hospitalId")?.value,
          patientName: document.getElementById("patientName")?.value,
          age: document.getElementById("age")?.value,
          gender: document.getElementById("gender")?.value,
          phone: document.getElementById("phone")?.value,
          testType: document.getElementById("testType")?.value,
          dateSelect: dateSelect.value,
          customDate: customDate.value
        });

        const appointmentData = {
          hospitalId: document.getElementById("hospitalId").value || "",
          name: document.getElementById("patientName").value || "",
          age: document.getElementById("age").value || "",
          gender: document.getElementById("gender").value || "",
          phone: document.getElementById("phone").value || "",
          testType: document.getElementById("testType").value || "",
          date: dateSelect.value === "custom" ? customDate.value : dateSelect.value,
          time: "09:00 AM",
          status: 'pending',
          createdAt: new Date().toISOString()
        };

        console.log("Form data to be added:", appointmentData); // Debug log
        console.log("Appointments collection reference:", window.appointmentsCollection); // Debug log

        try {
          console.log("Attempting to add document to Firestore..."); // Debug log
          const docRef = await addDoc(window.appointmentsCollection, appointmentData);
          console.log("Document written with ID: ", docRef.id); // Debug log
          form.reset();
          customDate.style.display = "none";
          console.log("Appointment added successfully:", appointmentData);
        } catch (error) {
          console.error("Error adding appointment to Firestore:", error);
          console.error("Error details:", {
            code: error.code,
            message: error.message,
            stack: error.stack
          });
          alert("Error adding appointment. Please check the console for details.");
        }
      });

      // Date select handler
      dateSelect.addEventListener("change", () => {
        customDate.style.display = dateSelect.value === "custom" ? "block" : "none";
      });
    }

    // Wait for Firebase to be initialized
    const checkFirebaseInterval = setInterval(() => {
      if (window.isFirebaseInitialized) {
        clearInterval(checkFirebaseInterval);
        setupPage();
      }
    }, 100);
  </script>

</body>
</html>
